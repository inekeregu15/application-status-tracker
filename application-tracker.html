<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optional Application Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        :root { font-family: 'Inter', sans-serif; }
        @supports (font-variation-settings: normal) {
            :root { font-family: 'Inter var', sans-serif; }
        }
        body {
            background-color: #f0f4f8;
        }
        .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .status-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        /* Custom Status Colors for clarity */
        .status-Submitted { background-color: #bfdbfe; color: #1e40af; } /* Blue */
        .status-InReview { background-color: #fde68a; color: #b45309; } /* Yellow/Amber */
        .status-Approved { background-color: #d1fae5; color: #065f46; } /* Green */
        .status-Denied { background-color: #fee2e2; color: #991b1b; } /* Red */
        .status-Completed { background-color: #e0f2f1; color: #0e7490; } /* Cyan */
        .status-OnHold { background-color: #f3e8ff; color: #7e22ce; } /* Purple */
        .status-Returned { background-color: #fef3c7; color: #d97706; } /* Orange */
        .hidden { display: none !important; }

        /* Modal animation */
        #messageModal {
            transition: opacity 0.3s ease;
        }
        #messageModal > div {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <!-- Main Application Card -->
    <div id="app" class="w-full max-w-2xl bg-white rounded-xl card p-6 md:p-8">
        <div class="text-center mb-8">
            <!-- Logo area (no blue border/background) -->
            <div class="inline-flex items-center justify-center w-20 h-20 bg-transparent rounded-full mb-4">
                <img src="https://prbs.pnp.gov.ph/wp-content/uploads/2022/05/PNP-PRBS.png" alt="PNP PRBS Logo" class="h-16 w-16 object-contain" onerror="this.style.display='none'">
            </div>
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">
                Optional Application Tracker
            </h1>
            <p class="text-center text-gray-500 mt-1">
                Check the status of your retirement application folder(s).
            </p>
        </div>

        <!-- Search Form Card -->
        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                Find Application
            </h2>
            <form id="searchForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- First Name Input (Column C) -->
                    <div>
                        <label for="firstNameInput" class="flex items-center text-sm font-semibold text-gray-700 mb-1">
                            <span>First Name</span><span class="text-red-500 ml-1">*</span>
                        </label>
                        <input type="text" id="firstNameInput" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., Juan">
                    </div>
                    <!-- Middle Name Input (Column D) -->
                    <div>
                        <label for="middleNameInput" class="text-sm font-semibold text-gray-700 mb-1">Middle Name</label>
                        <input type="text" id="middleNameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., Santos (Optional)">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Last Name Input (Column B) -->
                    <div>
                        <label for="lastNameInput" class="flex items-center text-sm font-semibold text-gray-700 mb-1">
                            <span>Last Name</span><span class="text-red-500 ml-1">*</span>
                        </label>
                        <input type="text" id="lastNameInput" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., Dela Cruz">
                    </div>
                    <!-- Birthday Input (Column I) -->
                    <div>
                        <label for="birthdayInput" class="flex items-center text-sm font-semibold text-gray-700 mb-1">
                            <span>Birthday</span><span class="text-red-500 ml-1">*</span>
                        </label>
                        <input type="date" id="birthdayInput" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 mt-6">
                    <button type="submit" id="searchButton" class="w-full flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 flex items-center justify-center">
                        <span id="buttonText">Search</span>
                        <svg id="loadingSpinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    <button type="button" id="clearButton" class="w-full sm:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition duration-200">
                        Clear
                    </button>
                </div>
            </form>
        </div>

        <!-- Status Results Area -->
        <div id="resultsArea" class="hidden">
            <h2 id="resultsHeader" class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                Latest Application Status
            </h2>
            <div id="resultsContainer" class="space-y-6">
                <!-- Individual result cards will be injected here -->
            </div>
            <p id="matchMessage" class="text-sm text-center mt-4 p-3 bg-blue-50 text-blue-800 border border-blue-200 rounded-lg hidden"></p>
        </div>

        <!-- How-to-Search Card -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
            <h3 class="font-semibold text-blue-800 mb-2 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                How to Search
            </h3>
            <p class="text-sm text-blue-700">
                To check your application status, please enter your details in the form above. Fields marked with <span class="text-red-500 font-bold">*</span> are required.
            </p>
        </div>

        <!-- Footer -->
        <div class="text-center text-xs text-gray-400 mt-8 border-t pt-4">
            <p>PNP Retirement and Benefits Administration Service (PRBS)</p>
            <p>For inquiries, please contact your respective regional office.</p>
        </div>
    </div>

    <!-- Modal for displaying messages -->
    <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-xl bg-white scale-95 transform">
            <div class="mt-3 text-center">
                <div id="modalIcon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <!-- Icon will be inserted here by JS -->
                </div>
                <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900 mt-4"></h3>
                <div class="mt-2 px-2 py-3">
                    <p id="modalMessage" class="text-sm text-gray-500 whitespace-pre-wrap"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeModalButton" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // UPDATE THIS URL WITH YOUR ACTUAL GOOGLE APPS SCRIPT WEB APP URL
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxtnR7iPpo6VHYTzt2jYx9kkn-DmLZgTGnN7lgwWa88yT8PGAvW1QLUtMKAAuBYq41h/exec";

        // --- DOM ELEMENT REFERENCES ---
        const searchForm = document.getElementById('searchForm');
        const searchButton = document.getElementById('searchButton');
        const clearButton = document.getElementById('clearButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const buttonText = document.getElementById('buttonText');
        const resultsArea = document.getElementById('resultsArea');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsHeader = document.getElementById('resultsHeader'); 
        const matchMessage = document.getElementById('matchMessage');
        const modal = document.getElementById('messageModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalIcon = document.getElementById('modalIcon');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');

        // --- MOCK DATA (FOR DEMO/TESTING ONLY) ---
        const MOCK_RESULTS = [{
                'FULL NAME': 'DELA CRUZ, Juan Santos (Record 1/2 - Older)', 
                'RANK': 'Police Major', 
                'UNIT/REGION': 'PRO-NCRPO', 
                'STATUS': 'In Review', 
                'EFFECTIVITY DATE': 'October 16, 2026', 
                'DATE RECEIVED': 'September 15, 2025', 
                'DATE REVIEW': 'September 16, 2025', 
                'RETURNED WITH DISCREPANCY': 'N/A',
                'ON HOLD': 'N/A',
                'PULL-OUT OF APPLICATION': 'N/A',
                'DATE FORWARDED IN TCDA': 'September 17, 2025', 
                'DATE FORWARDED IN NAPOLCOM': 'October 2, 2025' 
            },
            {
                'FULL NAME': 'DELA CRUZ, Juan Santos (Record 2/2 - Latest)',
                'RANK': 'Police Lieutenant',
                'UNIT/REGION': 'Camp Crame',
                'STATUS': 'Submitted',
                'EFFECTIVITY DATE': 'January 1, 2027',
                'DATE RECEIVED': 'October 10, 2025', 
                'DATE REVIEW': 'N/A',
                // Example: ON HOLD is active (Red)
                'RETURNED WITH DISCREPANCY': 'N/A',
                'ON HOLD': 'December 1, 2025',
                'PULL-OUT OF APPLICATION': 'N/A',
                'DATE FORWARDED IN TCDA': 'N/A',
                'DATE FORWARDED IN NAPOLCOM': 'N/A'
            }
        ];


        // --- MODAL DIALOG LOGIC ---
        function showMessage(title, message, type = 'error') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalIcon.innerHTML = ''; // Clear previous icon
            let iconClass = '';
            let iconSvg = '';

            switch (type) {
                case 'success':
                    iconClass = 'bg-green-100';
                    iconSvg = `<svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
                    break;
                case 'info':
                    iconClass = 'bg-blue-100';
                    iconSvg = `<svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                    break;
                default: // error
                    iconClass = 'bg-red-100';
                    iconSvg = `<svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`;
            }

            modalIcon.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${iconClass}`;
            modalIcon.innerHTML = iconSvg;
            modal.classList.remove('hidden');
            setTimeout(() => modal.querySelector('div').classList.remove('scale-95'), 10); // Animate in
        }

        function hideModal() {
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300); // Wait for animation
        }

        closeModalButton.addEventListener('click', hideModal);
        modal.addEventListener('click', (event) => {
            if (event.target === modal) hideModal();
        });

        /**
         * Creates and returns an HTML string for a single application result card.
         * @param {Object} data - The application data object.
         * @param {number} index - The index of the result (for display purposes).
         */
        function createResultCard(data, index) {
            const statusText = data['STATUS'] || 'Unknown';
            const statusClass = statusText.replace(/\s+/g, '');
            const fullName = data['FULL NAME'] ? `<h3 class="text-lg font-bold text-gray-900 mb-4">${data['FULL NAME']}</h3>` : '';

            // Helper function to determine if a status step is active (has a date)
            const isStatusActive = (key) => data[key] && data[key] !== 'N/A';
            
            // Helper function to create a timeline entry (blue for standard, red for exception)
            const createTimelineEntry = (label, key, isException = false) => {
                const isActive = isStatusActive(key);
                // Determine classes for label and date
                let labelClass = isException ? 'text-red-700 font-bold' : 'text-blue-700 font-medium';
                // Date class: Red Semibold if active and exception, Gray Semibold if active and standard, Gray/Normal otherwise
                let dateClass = isActive 
                    ? (isException ? 'text-red-600 font-semibold' : 'text-gray-800 font-semibold') 
                    : 'text-gray-800';

                // If not active and it's an exception item, de-emphasize with gray colors
                if (!isActive && isException) {
                    labelClass = 'text-gray-600 font-medium';
                    dateClass = 'text-gray-500';
                }

                // If not active and it's a standard item, keep the standard blue label but let the date default to gray-800
                if (!isActive && !isException) {
                    // Retain text-blue-700 for the label even when inactive for clarity of the standard flow
                    labelClass = 'text-blue-700 font-medium'; 
                    // dateClass remains 'text-gray-800' from the initial assignment
                }


                return `
                    <div class="flex justify-between">
                        <span class="${labelClass}">${label}:</span>
                        <span class="${dateClass}">${data[key] || 'N/A'}</span>
                    </div>
                `;
            };

            return `
                <div class="bg-white p-6 rounded-xl border-t-4 border-blue-600 shadow-md">
                    ${fullName}
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center border-b pb-2">
                                <span class="text-gray-600 font-medium">Effectivity Date:</span>
                                <span class="text-gray-900 font-semibold text-left sm:text-right">${data['EFFECTIVITY DATE'] || 'N/A'}</span>
                            </div>
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center border-b pb-2">
                                <span class="text-gray-600 font-medium">Status:</span>
                                <span><span class="status-pill status-${statusClass}">${statusText}</span></span>
                            </div>
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center border-b pb-2">
                                <span class="text-gray-600 font-medium">Rank:</span>
                                <span class="text-gray-900 font-semibold text-left sm:text-right">${data['RANK'] || 'N/A'}</span>
                            </div>
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center border-b pb-2">
                                <span class="text-gray-600 font-medium">Unit/Region:</span>
                                <span class="text-gray-900 font-semibold text-left sm:text-right">${data['UNIT/REGION'] || 'N/A'}</span>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-3 rounded-lg mt-4 border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-2">Detailed Status Timeline</h4>
                            <div class="space-y-2 text-sm">
                                ${createTimelineEntry('Date Received', 'DATE RECEIVED')}
                                ${createTimelineEntry('Date Review', 'DATE REVIEW')}
                                
                                <!-- New Exception Statuses (Red and Bold if active) -->
                                ${createTimelineEntry('RETURNED WITH DISCREPANCY', 'RETURNED WITH DISCREPANCY', true)}
                                ${createTimelineEntry('ON HOLD', 'ON HOLD', true)}
                                ${createTimelineEntry('PULL-OUT OF APPLICATION', 'PULL-OUT OF APPLICATION', true)}

                                <!-- Final Forwarding Steps -->
                                ${createTimelineEntry('Date Forwarded (TCDA)', 'DATE FORWARDED IN TCDA')}
                                ${createTimelineEntry('Date Forwarded (NAPOLCOM)', 'DATE FORWARDED IN NAPOLCOM')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- FORM HANDLING LOGIC ---
        searchForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            resultsArea.classList.add('hidden');
            resultsContainer.innerHTML = ''; // Clear old results

            const lastName = document.getElementById('lastNameInput').value.trim();
            const firstName = document.getElementById('firstNameInput').value.trim();
            const middleName = document.getElementById('middleNameInput').value.trim();
            const birthday = document.getElementById('birthdayInput').value;

            if (!lastName || !firstName || !birthday) {
                showMessage('Missing Information', 'Please fill in all required fields:\nLast Name, First Name, and Birthday.', 'error');
                return;
            }

            // Set loading state
            buttonText.textContent = 'Searching...';
            loadingSpinner.classList.remove('hidden');
            searchButton.disabled = true;

            try {
                if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL.includes("YOUR_SCRIPT_ID")) {
                    // --- MOCK DATA SIMULATION (LATEST ONLY) ---
                    // Record 2/2 is the latest one.
                    const latestResult = [MOCK_RESULTS[1]]; 
                    const mockMessage = latestResult.length > 1 
                        ? "Using mock data. Multiple records were found, but only the **latest one** based on Date Received is displayed."
                        : "Using mock data. One application record found.";
                        
                    displayResults(latestResult, mockMessage);
                    return;
                    // throw new Error('Please update the GAS_WEB_APP_URL constant in the script with your actual Google Apps Script URL.');
                }

                const url = new URL(GAS_WEB_APP_URL);
                url.searchParams.append('ln', lastName);
                url.searchParams.append('fn', firstName);
                url.searchParams.append('mn', middleName);
                url.searchParams.append('bd', birthday);

                console.log('Making request to:', url.toString());
                
                // Implement exponential backoff for API calls
                let response = null;
                const maxRetries = 3;
                let delay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(url);
                        if (response.status !== 429) break; // Break if not rate limiting
                    } catch (err) {
                        console.error("Fetch attempt failed:", err);
                        if (i === maxRetries - 1) throw err;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
                
                if (!response.ok) {
                    throw new Error(`The server responded with status: ${response.status}. Please try again later.`);
                }

                const result = await response.json();
                console.log('Response received:', result);

                if (result.status === 'success' && result.data && result.data.length > 0) {
                    // Since the backend now only returns the LATEST match, we display it.
                    displayResults(result.data, result.message);
                } else {
                    showMessage('Application Not Found', result.message || 'No matching applications were found for the provided details.', 'info');
                }
            } catch (error) {
                console.error('Error:', error);
                if (error.message.includes('GAS_WEB_APP_URL')) {
                     showMessage('Configuration Error', error.message, 'error');
                } else {
                    showMessage('Connection Error', `An error occurred: ${error.message}\n\nPlease check your internet connection and ensure the service is available.`, 'error');
                }
            } finally {
                // Reset loading state
                buttonText.textContent = 'Search';
                loadingSpinner.classList.add('hidden');
                searchButton.disabled = false;
            }
        });

        /**
         * Clears previous results and displays new results in the DOM.
         * @param {Array<Object>} results - Array of application objects (expected to be length 1 now).
         * @param {string} message - Message to display below the results.
         */
        function displayResults(results, message) {
            resultsContainer.innerHTML = '';
            results.forEach((data, index) => {
                // We rely on the backend (code.gs) to correctly format the 'FULL NAME' field now.
                const cardHtml = createResultCard(data, index);
                resultsContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
            
            // Update the header to reflect the single-result focus
            resultsHeader.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>Latest Application Status`;

            matchMessage.textContent = message;
            matchMessage.classList.remove('hidden');
            resultsArea.classList.remove('hidden');
        }

        clearButton.addEventListener('click', function() {
            searchForm.reset();
            resultsArea.classList.add('hidden');
            resultsContainer.innerHTML = '';
            matchMessage.classList.add('hidden');
            document.getElementById('lastNameInput').focus();
        });

        // --- PAGE INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            // Set focus on the first input
            document.getElementById('firstNameInput').focus();
        });
    </script>
</body>
</html>
